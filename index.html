import React, { useState, useEffect, useCallback } from 'react';
import { Trophy, RotateCcw, CheckCircle2, XCircle, Star, Skull, ChevronRight, Trees as Tree, Flame } from 'lucide-react';

const App = () => {
  // Estados principales
  const [gameState, setGameState] = useState('menu'); 
  const [mode, setMode] = useState(null);
  const [difficulty, setDifficulty] = useState('principiante');
  const [score, setScore] = useState(0);
  const [question, setQuestion] = useState({ a: 0, b: 0, op: '', answer: 0 });
  const [options, setOptions] = useState([]);
  const [feedback, setFeedback] = useState(null);
  const [medals, setMedals] = useState([]);
  
  const childName = "Llorens";

  const medalConfig = [
    { id: 'huevo', name: 'Huevo de Dino', points: 50, icon: 'ü•ö' },
    { id: 'bebe', name: 'Dino Beb√©', points: 150, icon: 'ü¶ñ' },
    { id: 'tricera', name: 'Triceratops', points: 300, icon: 'üõ°Ô∏è' },
    { id: 't-rex', name: 'Rey T-Rex', points: 500, icon: 'üëë' },
  ];

  const playSound = (type) => {
    try {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();

      osc.connect(gain);
      gain.connect(ctx.destination);

      if (type === 'success') {
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(523.25, ctx.currentTime); // C5
        osc.frequency.exponentialRampToValueAtTime(1046.50, ctx.currentTime + 0.1); // C6
        gain.gain.setValueAtTime(0.1, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
        osc.start();
        osc.stop(ctx.currentTime + 0.4);
      } else {
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(110, ctx.currentTime);
        osc.frequency.linearRampToValueAtTime(40, ctx.currentTime + 0.2);
        gain.gain.setValueAtTime(0.1, ctx.currentTime);
        gain.gain.linearRampToValueAtTime(0.01, ctx.currentTime + 0.3);
        osc.start();
        osc.stop(ctx.currentTime + 0.3);
      }
    } catch (e) {
      console.error("Audio error", e);
    }
  };

  const speak = (text) => {
    if ('speechSynthesis' in window) {
      window.speechSynthesis.cancel();
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'es-ES';
      // Voz m√°s animada: tono m√°s alto y velocidad un poco m√°s r√°pida
      utterance.pitch = 1.4; 
      utterance.rate = 1.1;
      window.speechSynthesis.speak(utterance);
    }
  };

  const generateQuestion = useCallback((currentMode, currentDiff) => {
    let a, b, op, ans;
    const diff = currentDiff || difficulty;
    const m = currentMode || mode;

    let maxNum = 10;
    if (diff === 'medio') maxNum = 30;
    if (diff === 'avanzado') maxNum = 100;

    if (m === 'suma') {
      a = Math.floor(Math.random() * maxNum) + 1;
      b = Math.floor(Math.random() * maxNum) + 1;
      op = '+';
      ans = a + b;
    } else if (m === 'resta') {
      a = Math.floor(Math.random() * maxNum) + (maxNum / 2);
      b = Math.floor(Math.random() * a) + 1;
      op = '-';
      ans = a - b;
    } else {
      let multMax = diff === 'principiante' ? 5 : (diff === 'medio' ? 10 : 12);
      a = Math.floor(Math.random() * multMax) + 1;
      b = Math.floor(Math.random() * 10) + 1;
      op = '√ó';
      ans = a * b;
    }

    setQuestion({ a, b, op, answer: ans });

    let opts = [ans];
    while (opts.length < 4) {
      let range = diff === 'avanzado' ? 20 : 10;
      let wrong = ans + (Math.floor(Math.random() * range) + 1) * (Math.random() > 0.5 ? 1 : -1);
      if (wrong >= 0 && !opts.includes(wrong)) {
        opts.push(wrong);
      }
    }
    setOptions(opts.sort(() => Math.random() - 0.5));
  }, [difficulty, mode]);

  const selectMode = (type) => {
    setMode(type);
    setGameState('difficulty');
    speak(`¬°Muy bien ${childName}! Elige tu nivel de explorador.`);
  };

  const startLevel = (diff) => {
    setDifficulty(diff);
    setGameState('playing');
    generateQuestion(mode, diff);
  };

  const handleAnswer = (selected) => {
    if (selected === question.answer) {
      setFeedback('correct');
      playSound('success');
      
      const phrases = [
        `¬°Roooar! ¬°Incre√≠ble ${childName}!`,
        `¬°Dino-√©xito total ${childName}!`,
        `¬°Eres el rey de la selva ${childName}!`,
        `¬°Qu√© colosal eres ${childName}!`,
        `¬°Aplausos para el mejor explorador!`,
        `¬°Magn√≠fico ${childName}!`
      ];
      speak(phrases[Math.floor(Math.random() * phrases.length)]);
      
      const newScore = score + 10;
      setScore(newScore);
      
      const earned = medalConfig.filter(m => newScore >= m.points && !medals.includes(m.id)).map(m => m.id);
      if (earned.length > 0) {
        setMedals([...medals, ...earned]);
        speak(`¬°Wow ${childName}! ¬°Has encontrado un nuevo dinosaurio para tu colecci√≥n!`);
      }

      setTimeout(() => {
        setFeedback(null);
        generateQuestion();
      }, 1500);
    } else {
      setFeedback('wrong');
      playSound('error');
      setTimeout(() => setFeedback(null), 800);
    }
  };

  const resetAll = () => {
    setScore(0);
    setMedals([]);
    setGameState('menu');
  };

  return (
    <div className="min-h-[100dvh] bg-gradient-to-b from-[#1a2e05] via-[#2d4a22] to-[#132406] font-sans p-4 flex flex-col items-center touch-manipulation select-none overflow-hidden relative">
      
      {/* Elementos de ambientaci√≥n Jurassic Park */}
      <div className="absolute top-[-20px] left-[-20px] opacity-10 text-9xl">üåø</div>
      <div className="absolute top-40 right-[-30px] opacity-10 text-8xl rotate-45">üåø</div>
      <div className="absolute bottom-20 left-[-20px] opacity-20 text-7xl rotate-12">üë£</div>
      <div className="absolute top-10 right-10 opacity-30 animate-pulse">
         <Flame className="text-orange-600 w-12 h-12" />
         <div className="w-16 h-8 bg-gray-800 rounded-t-full mt-[-5px]"></div>
      </div>

      {/* Cabecera Estilo Roca Tallada */}
      <header className="w-full max-w-lg bg-[#d9c5a0] rounded-2xl p-3 shadow-[0_8px_0_#8b7355] flex justify-between items-center mb-6 border-4 border-[#5c4033] z-10">
        <div className="flex flex-col items-start px-2">
          <span className="text-[10px] font-black text-[#5c4033] uppercase leading-none mb-1">Explorador: {childName}</span>
          <div className="flex items-center gap-2">
            <div className="bg-[#5c4033] p-1 rounded-full border border-[#ffd700]">
              <Trophy className="text-[#ffd700] w-4 h-4" />
            </div>
            <span className="text-2xl font-black text-[#5c4033] drop-shadow-sm">{score}</span>
          </div>
        </div>
        
        <div className="flex gap-1.5 bg-black/10 p-2 rounded-xl border border-white/20">
          {medalConfig.map(m => (
            <span key={m.id} className={`text-2xl transition-all duration-500 ${medals.includes(m.id) ? 'scale-125 drop-shadow-md' : 'grayscale opacity-30 contrast-50'}`} title={m.name}>
              {m.icon}
            </span>
          ))}
        </div>

        <button onClick={resetAll} className="p-2 bg-[#8b5a2b] rounded-full active:scale-90 border-2 border-[#5c4033] shadow-inner">
          <RotateCcw className="w-5 h-5 text-[#f5f5dc]" />
        </button>
      </header>

      {/* Main Content */}
      <main className="w-full max-w-lg flex-grow flex flex-col justify-center gap-6 z-10">
        
        {gameState === 'menu' && (
          <div className="animate-in fade-in zoom-in duration-700 text-center">
            <div className="relative inline-block mb-4">
               <h1 className="text-6xl font-black text-[#facc15] drop-shadow-[0_6px_0_#854d0e] tracking-tight">DINOMATES</h1>
               <div className="absolute -top-6 -right-8 rotate-12 bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded-md border-2 border-white shadow-lg">EDICI√ìN {childName.toUpperCase()}</div>
            </div>
            <p className="text-[#bef264] font-black mb-8 uppercase tracking-[0.3em] text-sm drop-shadow-md">Sobrevive a las Cifras</p>
            
            <div className="grid gap-5">
              {[
                { id: 'suma', label: 'Sumar', icon: 'ü¶ï', color: 'bg-[#4ade80] border-[#166534] shadow-[#166534]' },
                { id: 'resta', label: 'Restar', icon: 'ü¶ñ', color: 'bg-[#fb923c] border-[#9a3412] shadow-[#9a3412]' },
                { id: 'multi', label: 'Multiplicar', icon: 'ü¶Ö', color: 'bg-[#f472b6] border-[#9d174d] shadow-[#9d174d]' }
              ].map(b => (
                <button
                  key={b.id}
                  onClick={() => selectMode(b.id)}
                  className={`${b.color} w-full py-6 rounded-[2.5rem] border-b-[10px] flex items-center justify-between px-10 text-white text-3xl font-black active:translate-y-2 active:border-b-4 transition-all`}
                >
                  <span className="text-5xl filter drop-shadow-lg">{b.icon}</span> 
                  {b.label}
                  <ChevronRight className="w-8 h-8 opacity-40" />
                </button>
              ))}
            </div>
          </div>
        )}

        {gameState === 'difficulty' && (
          <div className="animate-in slide-in-from-right duration-400 text-center px-4">
            <h2 className="text-3xl font-black text-[#fef08a] mb-8 uppercase italic tracking-wider drop-shadow-md">¬øQu√© tan valiente eres, {childName}?</h2>
            <div className="grid gap-5">
              {[
                { id: 'principiante', label: 'Herb√≠voro', desc: 'Tranquilo (1-10)', color: 'bg-[#86efac] border-[#166534] text-[#064e3b]' },
                { id: 'medio', label: 'Cazador', desc: 'Veloz (1-30)', color: 'bg-[#fde047] border-[#854d0e] text-[#422006]' },
                { id: 'avanzado', label: 'Depredador', desc: '¬°Peligro! (1-100)', color: 'bg-[#f87171] border-[#7f1d1d] text-white' }
              ].map(d => (
                <button
                  key={d.id}
                  onClick={() => startLevel(d.id)}
                  className={`${d.color} w-full p-6 rounded-3xl border-b-[10px] active:translate-y-2 active:border-b-4 transition-all shadow-xl`}
                >
                  <div className="text-3xl font-black uppercase tracking-tight">{d.label}</div>
                  <div className="text-xs opacity-90 font-bold mt-1 uppercase tracking-widest">{d.desc}</div>
                </button>
              ))}
              <button onClick={() => setGameState('menu')} className="mt-6 text-[#bef264] font-black uppercase text-sm tracking-widest hover:text-white transition-colors">‚Üê Volver al Refugio</button>
            </div>
          </div>
        )}

        {gameState === 'playing' && (
          <div className="bg-[#fefce8] rounded-[3.5rem] p-8 shadow-[0_20px_50px_rgba(0,0,0,0.5)] border-b-[16px] border-[#eab308] relative overflow-hidden flex flex-col items-center border-4 border-[#5c4033]">
            
            {/* Feedback √âxito */}
            {feedback === 'correct' && (
              <div className="absolute inset-0 bg-[#4ade80]/95 flex flex-col items-center justify-center z-20 animate-in zoom-in duration-300">
                <div className="text-[120px] mb-4 animate-bounce">üëè</div>
                <h2 className="text-5xl font-black text-white drop-shadow-[0_4px_0_#166534]">¬°GIGANTE!</h2>
                <p className="text-white font-black text-xl mt-2 uppercase tracking-widest">{childName}</p>
              </div>
            )}
            
            {/* Feedback Error */}
            {feedback === 'wrong' && (
              <div className="absolute inset-0 bg-[#ef4444]/95 flex flex-col items-center justify-center z-20 animate-in shake duration-200">
                <Skull className="w-28 h-28 text-white mb-4 animate-pulse" />
                <h2 className="text-4xl font-black text-white italic">¬°CUIDADO!</h2>
              </div>
            )}

            <div className="w-full flex justify-between items-center mb-10">
              <span className="bg-[#4d7c0f] text-[#d9f99d] px-5 py-1.5 rounded-full text-xs font-black uppercase border-b-2 border-[#1a2e05]">
                {mode}
              </span>
              <span className="bg-[#854d0e] text-[#fef9c3] px-5 py-1.5 rounded-full text-xs font-black uppercase border-b-2 border-[#422006]">
                {difficulty}
              </span>
            </div>

            {/* Panel de Operaci√≥n */}
            <div className="flex flex-col items-center mb-12">
               <div className="flex items-center gap-6 bg-[#f5f5dc] p-10 rounded-[3rem] shadow-inner border-4 border-[#d2b48c] relative">
                  <div className="absolute -top-4 -left-4 text-4xl opacity-40">ü¶¥</div>
                  <span className="text-8xl font-black text-[#422006] drop-shadow-sm">{question.a}</span>
                  <span className="text-5xl font-black text-[#ca8a04] animate-pulse">{question.op}</span>
                  <span className="text-8xl font-black text-[#422006] drop-shadow-sm">{question.b}</span>
               </div>
            </div>

            {/* Opciones */}
            <div className="grid grid-cols-2 gap-5 w-full">
              {options.map((opt, i) => (
                <button
                  key={i}
                  onClick={() => handleAnswer(opt)}
                  disabled={feedback !== null}
                  className="bg-[#16a34a] text-white py-8 rounded-[2.5rem] text-5xl font-black border-b-[10px] border-[#14532d] active:translate-y-2 active:border-b-2 transition-all shadow-xl active:bg-[#15803d]"
                >
                  {opt}
                </button>
              ))}
            </div>

            <button onClick={() => setGameState('difficulty')} className="mt-10 text-[#854d0e] font-black uppercase text-xs flex items-center gap-2 opacity-50 hover:opacity-100 transition-opacity">
              <RotateCcw size={14} /> Reintentar Expedici√≥n
            </button>
          </div>
        )}
      </main>

      {/* Decoraci√≥n inferior */}
      <footer className="w-full max-w-lg mt-auto py-6 flex justify-around items-end z-10">
         <div className="flex flex-col items-center animate-bounce" style={{animationDelay: '0s'}}>
            <span className="text-4xl">ü¶ñ</span>
            <div className="w-10 h-2 bg-black/20 rounded-full blur-sm"></div>
         </div>
         <div className="flex flex-col items-center animate-bounce" style={{animationDelay: '0.3s'}}>
            <span className="text-5xl">üåã</span>
         </div>
         <div className="flex flex-col items-center animate-bounce" style={{animationDelay: '0.1s'}}>
            <span className="text-4xl">ü¶ï</span>
            <div className="w-10 h-2 bg-black/20 rounded-full blur-sm"></div>
         </div>
         <div className="flex flex-col items-center animate-bounce" style={{animationDelay: '0.4s'}}>
            <span className="text-3xl">üå¥</span>
         </div>
      </footer>

      <style dangerouslySetInnerHTML={{ __html: `
        @keyframes shake {
          0%, 100% { transform: translateX(0); }
          25% { transform: translateX(-20px); }
          75% { transform: translateX(20px); }
        }
        .animate-shake { animation: shake 0.2s ease-in-out infinite; }
        
        /* Efecto de ruido/textura sutil para el fondo */
        .bg-gradient-to-b::after {
          content: "";
          position: absolute;
          inset: 0;
          opacity: 0.05;
          pointer-events: none;
          background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }
      `}} />
    </div>
  );
};

export default App;
